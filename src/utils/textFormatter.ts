import type { ChatMessage } from '../types/messages'

/**
 * ãƒãƒ£ãƒƒãƒˆãƒ‡ãƒ¼ã‚¿ã®é…åˆ—ã‚’1ã¤ã®Markdownæ–‡å­—åˆ—ã«æ•´å½¢ã™ã‚‹é–¢æ•°
 * @param chatData - Content Scriptã‹ã‚‰å—ã‘å–ã£ãŸãƒãƒ£ãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®é…åˆ—
 * @returns æ•´å½¢ã•ã‚ŒãŸMarkdownæ–‡å­—åˆ—
 */
export function formatAsMarkdown(chatData: ChatMessage[]): string {
  if (!chatData || chatData.length === 0) {
    return '# Gemini Chat Export\n\nNo chat messages found.'
  }

  const header = `# Gemini Chat Export

**Generated on:** ${new Date().toLocaleString()}  
**Total messages:** ${chatData.length}

---

`

  const messagesText = chatData
    .map((message, index) => {
      const timestamp = message.timestamp 
        ? new Date(message.timestamp).toLocaleString()
        : 'Unknown time'
      
      const sender = message.type === 'user' ? 'ğŸ‘¤ User' : 'ğŸ¤– Gemini'
      let content = message.content.trim()
      
      // Apply Markdown cleanup rules
      content = cleanupMarkdownContent(content)
      
      return `## [${index + 1}] ${sender}

**Time:** ${timestamp}

${content}

`
    })
    .join('\n')

  const footer = `---

*Generated by Gemini Chat Exporter*`

  return header + messagesText + footer
}

/**
 * Markdownã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ã‚’è¡Œã†é–¢æ•°
 * @param content - ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ã™ã‚‹Markdownæ–‡å­—åˆ—
 * @returns ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ã•ã‚ŒãŸMarkdownæ–‡å­—åˆ—
 */
function cleanupMarkdownContent(content: string): string {
  let result = content;
  
  // Step 1: ã‚³ãƒ¼ãƒ‰ãƒ–ãƒ­ãƒƒã‚¯å†…ã®ç„¡é§„ãªæ”¹è¡Œã‚’ç¢ºå®Ÿã«é™¤å»
  // ã‚ˆã‚ŠåŒ…æ‹¬çš„ãªãƒ‘ã‚¿ãƒ¼ãƒ³ãƒãƒƒãƒãƒ³ã‚°ã§ã€ã‚ã‚‰ã‚†ã‚‹ç©ºç™½ãƒ»æ”¹è¡Œãƒ‘ã‚¿ãƒ¼ãƒ³ã«å¯¾å¿œ
  
  // 1-1: è¨€èªæŒ‡å®šãªã—ã®ã‚³ãƒ¼ãƒ‰ãƒ–ãƒ­ãƒƒã‚¯ï¼ˆæœ€ã‚‚å•é¡Œã®å¤šã„ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼‰
  // ```ã®ç›´å¾Œã«æ”¹è¡Œãƒ»ç©ºç™½ãŒç¶šãã€ãã®å¾Œã«ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã€æœ€å¾Œã«```ã§çµ‚ã‚ã‚‹ãƒ‘ã‚¿ãƒ¼ãƒ³
  result = result.replace(/```\s*\n[\s\n]*([^`]+?)[\s\n]*```/gs, (_, code) => {
    const cleanCode = code.trim();
    return cleanCode ? `\`\`\`\n${cleanCode}\n\`\`\`` : '';
  });
  
  // 1-2: è¨€èªæŒ‡å®šã‚ã‚Šã®ã‚³ãƒ¼ãƒ‰ãƒ–ãƒ­ãƒƒã‚¯
  // ```è¨€èªåã®ç›´å¾Œã«æ”¹è¡Œãƒ»ç©ºç™½ãŒç¶šããƒ‘ã‚¿ãƒ¼ãƒ³
  result = result.replace(/```(\w+)\s*\n[\s\n]*([^`]+?)[\s\n]*```/gs, (_, lang, code) => {
    const cleanCode = code.trim();
    return cleanCode ? `\`\`\`${lang}\n${cleanCode}\n\`\`\`` : '';
  });
  
  // 1-3: ç©ºã®è¨€èªæŒ‡å®šï¼ˆ```ã®ç›´å¾Œã«ã‚¹ãƒšãƒ¼ã‚¹ãŒã‚ã‚‹å ´åˆï¼‰
  // ```â£ã®ç›´å¾Œã«æ”¹è¡Œãƒ»ç©ºç™½ãŒç¶šããƒ‘ã‚¿ãƒ¼ãƒ³
  result = result.replace(/```\s+\n[\s\n]*([^`]+?)[\s\n]*```/gs, (_, code) => {
    const cleanCode = code.trim();
    return cleanCode ? `\`\`\`\n${cleanCode}\n\`\`\`` : '';
  });
  
  // Step 2: æ®‹å­˜ã™ã‚‹å•é¡Œãƒ‘ã‚¿ãƒ¼ãƒ³ã¸ã®å¯¾å¿œ
  
  // 2-1: é€£ç¶šã™ã‚‹ç©ºç™½è¡Œãƒ‘ã‚¿ãƒ¼ãƒ³ã¸ã®è¿½åŠ å‡¦ç†
  result = result.replace(/```(\w*)\n\s*\n+([^`]+?)\n\s*```/gs, (_, lang, code) => {
    const cleanCode = code.trim();
    return cleanCode ? `\`\`\`${lang}\n${cleanCode}\n\`\`\`` : '';
  });
  
  // 2-2: ã‚³ãƒ¼ãƒ‰ãƒ–ãƒ­ãƒƒã‚¯å†…ã®é€£ç¶šã™ã‚‹ç©ºç™½è¡Œã‚’å˜ä¸€ã®æ”¹è¡Œã«å¤‰æ›
  result = result.replace(/```(\w*)\n([^`]*?)\n```/gs, (_, lang, code) => {
    // ã‚³ãƒ¼ãƒ‰å†…ã®é€£ç¶šã™ã‚‹ç©ºç™½è¡Œã‚’æ­£è¦åŒ–ï¼ˆãŸã ã—æ„å›³çš„ãªæ”¹è¡Œã¯ä¿æŒï¼‰
    const normalizedCode = code
      .replace(/\n\s*\n\s*\n/g, '\n\n')  // 3ã¤ä»¥ä¸Šã®é€£ç¶šæ”¹è¡Œã‚’2ã¤ã«
      .replace(/^\s+|\s+$/g, '');  // å‰å¾Œã®ç©ºç™½ã‚’é™¤å»
    
    return normalizedCode ? `\`\`\`${lang}\n${normalizedCode}\n\`\`\`` : '';
  });
  
  // Step 3: ã‚³ãƒ¼ãƒ‰ãƒ–ãƒ­ãƒƒã‚¯å‘¨è¾ºã®æ”¹è¡Œèª¿æ•´
  
  // 3-1: ã‚³ãƒ¼ãƒ‰ãƒ–ãƒ­ãƒƒã‚¯å‰ã®éåº¦ãªæ”¹è¡Œ
  result = result.replace(/\n{3,}```/g, '\n\n```');
  
  // 3-2: ã‚³ãƒ¼ãƒ‰ãƒ–ãƒ­ãƒƒã‚¯å¾Œã®éåº¦ãªæ”¹è¡Œ
  result = result.replace(/```\n{3,}/g, '```\n\n');
  
  // Step 4: ãã®ä»–ã®ä¸€èˆ¬çš„ãªã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
  
  // 4-1: ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³ã‚³ãƒ¼ãƒ‰å¾Œã®ä¸è¦ãªç©ºç™½ã‚’é™¤å»
  result = result.replace(/`([^`]+)`\s{2,}/g, '`$1` ');
  
  // 4-2: è¤‡æ•°ã®æ”¹è¡Œã‚’2ã¤ã¾ã§ã«åˆ¶é™
  result = result.replace(/\n{3,}/g, '\n\n');
  
  // 4-3: ãƒªã‚¹ãƒˆé …ç›®ã®æ”¹è¡Œã‚’æ­£è¦åŒ–
  result = result.replace(/^(\s*[-*+]\s+.+)\n+(?=\s*[-*+])/gm, '$1\n');
  result = result.replace(/^(\s*\d+\.\s+.+)\n+(?=\s*\d+\.)/gm, '$1\n');
  
  // 4-4: æ–‡æœ«ãƒ»æ–‡é ­ã®ä¸è¦ãªç©ºç™½è¡Œã‚’é™¤å»
  result = result.replace(/\n+$/, '').replace(/^\n+/, '');
  
  // 4-5: ã‚³ãƒ¼ãƒ‰ãƒ–ãƒ­ãƒƒã‚¯ç›´å¾Œã«ãƒ†ã‚­ã‚¹ãƒˆãŒç¶šãå ´åˆã®æ”¹è¡Œèª¿æ•´
  result = result.replace(/```\n([^\s\n`])/g, '```\n\n$1');
  
  return result;
}

/**
 * å¾“æ¥ã®ãƒ†ã‚­ã‚¹ãƒˆå½¢å¼ã¨ã®äº’æ›æ€§ã®ãŸã‚ã«æ®‹ã—ã¦ãŠãé–¢æ•°
 * @param chatData - Content Scriptã‹ã‚‰å—ã‘å–ã£ãŸãƒãƒ£ãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®é…åˆ—
 * @returns æ•´å½¢ã•ã‚ŒãŸãƒ—ãƒ¬ãƒ¼ãƒ³ãƒ†ã‚­ã‚¹ãƒˆæ–‡å­—åˆ—
 */
export function formatAsText(chatData: ChatMessage[]): string {
  // Markdownã¨ã—ã¦å‡ºåŠ›ï¼ˆå¾Œæ–¹äº’æ›æ€§ã®ãŸã‚ï¼‰
  return formatAsMarkdown(chatData)
}

/**
 * Markdownãƒ•ã‚¡ã‚¤ãƒ«åã‚’ç”Ÿæˆã™ã‚‹é–¢æ•°
 * @param prefix - ãƒ•ã‚¡ã‚¤ãƒ«åã®ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ (ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: 'gemini-chat')
 * @returns ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ä»˜ãã®Markdownãƒ•ã‚¡ã‚¤ãƒ«å
 */
export function generateFileName(prefix: string = 'gemini-chat'): string {
  const now = new Date()
  const dateStr = now.toISOString().split('T')[0] // YYYY-MM-DD
  const timeStr = now.toTimeString().split(' ')[0].replace(/:/g, '-') // HH-MM-SS
  
  return `${prefix}_${dateStr}_${timeStr}.md`
} 
