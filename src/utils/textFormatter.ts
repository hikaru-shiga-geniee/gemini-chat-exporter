import type { ChatMessage } from '../types/messages'

/**
 * ãƒãƒ£ãƒƒãƒˆãƒ‡ãƒ¼ã‚¿ã®é…åˆ—ã‚’1ã¤ã®Markdownæ–‡å­—åˆ—ã«æ•´å½¢ã™ã‚‹é–¢æ•°
 * @param chatData - Content Scriptã‹ã‚‰å—ã‘å–ã£ãŸãƒãƒ£ãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®é…åˆ—
 * @returns æ•´å½¢ã•ã‚ŒãŸMarkdownæ–‡å­—åˆ—
 */
export function formatAsMarkdown(chatData: ChatMessage[]): string {
  if (!chatData || chatData.length === 0) {
    return '# Gemini Chat Export\n\nNo chat messages found.'
  }

  const header = `# Gemini Chat Export

**Generated on:** ${new Date().toLocaleString()}  
**Total messages:** ${chatData.length}

---

`

  const messagesText = chatData
    .map((message, index) => {
      const timestamp = message.timestamp 
        ? new Date(message.timestamp).toLocaleString()
        : 'Unknown time'
      
      const sender = message.type === 'user' ? 'ğŸ‘¤ User' : 'ğŸ¤– Gemini'
      const content = message.content.trim()
      
      return `## [${index + 1}] ${sender}

**Time:** ${timestamp}

${content}

`
    })
    .join('\n')

  const footer = `---

*Generated by Gemini Chat Exporter*`

  return header + messagesText + footer
}

/**
 * å¾“æ¥ã®ãƒ†ã‚­ã‚¹ãƒˆå½¢å¼ã¨ã®äº’æ›æ€§ã®ãŸã‚ã«æ®‹ã—ã¦ãŠãé–¢æ•°
 * @param chatData - Content Scriptã‹ã‚‰å—ã‘å–ã£ãŸãƒãƒ£ãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®é…åˆ—
 * @returns æ•´å½¢ã•ã‚ŒãŸãƒ—ãƒ¬ãƒ¼ãƒ³ãƒ†ã‚­ã‚¹ãƒˆæ–‡å­—åˆ—
 */
export function formatAsText(chatData: ChatMessage[]): string {
  // Markdownã¨ã—ã¦å‡ºåŠ›ï¼ˆå¾Œæ–¹äº’æ›æ€§ã®ãŸã‚ï¼‰
  return formatAsMarkdown(chatData)
}

/**
 * Markdownãƒ•ã‚¡ã‚¤ãƒ«åã‚’ç”Ÿæˆã™ã‚‹é–¢æ•°
 * @param prefix - ãƒ•ã‚¡ã‚¤ãƒ«åã®ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ (ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: 'gemini-chat')
 * @returns ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ä»˜ãã®Markdownãƒ•ã‚¡ã‚¤ãƒ«å
 */
export function generateFileName(prefix: string = 'gemini-chat'): string {
  const now = new Date()
  const dateStr = now.toISOString().split('T')[0] // YYYY-MM-DD
  const timeStr = now.toTimeString().split(' ')[0].replace(/:/g, '-') // HH-MM-SS
  
  return `${prefix}_${dateStr}_${timeStr}.md`
} 
